<div class="join-container">
  <div class="navbar" *ngIf="!(isLoadingUser | async)">
    <ng-container *ngIf="vm | async as viewModel">
      <div class="navbar-left">
        <app-profile-dropdown *ngIf="viewModel.user"></app-profile-dropdown>
      </div>
      <div class="navbar-right">
        <button
          mat-button
          *ngIf="!viewModel.user"
          class="sign-in-button"
          #tooltip="matTooltip"
          matTooltip="Created a permanent account before? Jump right back."
          matTooltipPosition="right"
          (click)="onSignInClicked.next()"
        >
          <mat-icon>account_circle</mat-icon>
          Sign in
        </button>
      </div>
    </ng-container>
  </div>
  <img src="/assets/logo.png" class="logo" />
  <ng-container *ngIf="(vm | async)?.user">
    <ng-container *ngTemplateOutlet="welcomeBack"></ng-container>
  </ng-container>
  <ng-container *ngIf="pageMode | async; let pageMode">
    <mat-card
      appearance="outlined"
      class="action-card"
      resizeMonitor
      [verticalSpacing]="36"
    >
      <div class="transitioning-container" @delayedFadeAnimation>
        <ng-container *ngIf="pageMode === PageMode.CREATE">
          <ng-container *ngTemplateOutlet="create"></ng-container>
        </ng-container>
        <ng-container *ngIf="pageMode === PageMode.JOIN">
          <ng-container *ngTemplateOutlet="join"></ng-container>
        </ng-container>
      </div>
    </mat-card>
  </ng-container>
  <ng-container *ngTemplateOutlet="links"></ng-container>
</div>

<ng-template #create>
  <ng-container *ngIf="vm | async as viewModel; else loading">
    <mat-card-content>
      <form class="full-bleed">
        <ng-container *ngIf="!viewModel.user?.displayName">
          <ng-container *ngTemplateOutlet="nameTemplate"></ng-container>
        </ng-container>
        <ng-container *ngTemplateOutlet="joinMode"></ng-container>
      </form>
      <button
        color="primary"
        mat-flat-button
        (click)="onCreateRoomClicked.next()"
        [disabled]="(isBusy | async) || !name.value.length"
      >
        <mat-icon>add</mat-icon>
        Create new Room
      </button>
      <ng-container *ngIf="!viewModel.user">
        <ng-container *ngTemplateOutlet="terms"></ng-container>
      </ng-container>
    </mat-card-content>
  </ng-container>
</ng-template>

<ng-template #join>
  <ng-container *ngIf="vm | async as viewModel; else loading">
    <mat-card-content>
      <ng-container *ngIf="viewModel.roomId">
        <ng-container *ngTemplateOutlet="invitedToRoomText"></ng-container>
      </ng-container>
      <form class="full-bleed">
        <ng-container *ngIf="!viewModel.user?.displayName">
          <ng-container *ngTemplateOutlet="nameTemplate"></ng-container>
        </ng-container>
        <ng-container *ngIf="!viewModel.roomId">
          <ng-container *ngTemplateOutlet="roomIdTemplate"></ng-container>
        </ng-container>
        <ng-container *ngTemplateOutlet="joinMode"></ng-container>
      </form>

      <button
        mat-flat-button
        color="primary"
        [disabled]="
          !roomId.value.length || !name.value.length || (isBusy | async)
        "
        (click)="onJoinRoomClicked.next()"
      >
        <mat-icon>login</mat-icon>
        Join Room
      </button>
      <ng-container *ngIf="!viewModel.user">
        <ng-container *ngTemplateOutlet="terms"></ng-container>
      </ng-container>
    </mat-card-content>
  </ng-container>
  <zoom-app-banner
    *ngIf="!config.isRunningInZoom"
    bannerLocation="banner_join"
  ></zoom-app-banner>
</ng-template>

<ng-template #links>
  <div class="links">
    <a routerLink="/create" *ngIf="(pageMode | async) === PageMode.JOIN"
      >Create a new room</a
    >
    <a routerLink="/join" *ngIf="(pageMode | async) === PageMode.CREATE"
      >Join an existing room</a
    >
    <a
      routerLink="/history"
      [queryParams]="{ backToPage: '/' + (pageMode | async) }"
      >Previous sessions</a
    >
    <!--         <a (click)="signOut()" *ngIf="(vm | async)?.user">Delete temporary account</a>
 -->
  </div>
</ng-template>

<ng-template #welcomeBack>
  <div class="welcome-name-container">
    <h1>Welcome back, {{ (user | async)?.displayName }}!</h1>
  </div>
</ng-template>

<ng-template #invitedToRoomText>
  <h4>
    You've been invited to join room: <br />
    <strong>{{ (vm | async)?.roomId }}</strong>
  </h4>
</ng-template>

<ng-template #terms>
  <div class="terms">
    <small
      >By using this app you accept the <a routerLink="/terms">Terms</a> and the
      <a routerLink="/privacy">Privacy Policy</a>.</small
    >
  </div>
</ng-template>

<ng-template #roomIdTemplate>
  <mat-form-field class="room-id" appearance="outline">
    <mat-label>Room ID</mat-label>
    <input
      matInput
      placeholder="random-room-name"
      [formControl]="roomId"
      (blur)="onRoomIdBlur()"
      required
    />
  </mat-form-field>
</ng-template>

<ng-template #nameTemplate>
  <mat-form-field class="name" appearance="outline">
    <mat-label>Your name</mat-label>
    <input
      matInput
      placeholder="Best Engineer"
      [formControl]="name"
      autocomplete="name"
      (blur)="onNameBlur()"
      required
    />
  </mat-form-field>
</ng-template>

<ng-template #joinMode>
  <mat-form-field appearance="outline">
    <mat-label>Join as an</mat-label>
    <mat-select [formControl]="joinAs">
      <mat-option [value]="MemberType.ESTIMATOR">Estimator</mat-option>
      <mat-option [value]="MemberType.OBSERVER">Observer</mat-option>
    </mat-select>
    <mat-hint *ngIf="joinAs.value === MemberType.OBSERVER"
      >You can't estimate cards in this mode.</mat-hint
    >
  </mat-form-field>
</ng-template>

<ng-template #loading>
  <mat-card-content>
    <mat-progress-spinner
      mode="indeterminate"
      [diameter]="30"
    ></mat-progress-spinner>
  </mat-card-content>
</ng-template>
