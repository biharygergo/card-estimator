<mat-sidenav-container class="sidenav-container">
  <mat-sidenav-content class="sidenav-content" #sidenavContent>
    <div class="navbar">
      <div class="navbar-left">
        <app-profile-dropdown class="profile-dropdown"></app-profile-dropdown>
      </div>
      <div class="navbar-right">
        <button
          mat-stroked-button
          class="unlock-features-button responsive-label-button"
          matTooltip="Get the most out of your planning with Premium"
          *ngIf="
            (permissionsService.hasPremiumAccess() | async) === false &&
            room?.subscriptionMetadata?.createdWithPlan !== 'premium' &&
            !paymentService.isSubscriptionDisabled
          "
          (click)="openPremiumLearnMoreModal()"
          @fadeAnimation
        >
          <mat-icon>lock_open</mat-icon>
          Unlock features
        </button>
        <button
          mat-flat-button
          *ngIf="(user$ | async)?.isAnonymous"
          class="create-account-button responsive-label-button"
          matTooltip="Create an account to save your progress"
          (click)="onCreateAccountClicked()"
          @fadeAnimation
        >
          <mat-icon>account_circle</mat-icon>
          Create an account
        </button>
      </div>
    </div>
    <div class="room-container">
      <div class="meta-container">
        <mat-card
          appearance="outlined"
          class="topic-container rounded-card"
          resizeMonitor
          [verticalSpacing]="0"
        >
          <div>
            <mat-card-content>
              <h2 *ngIf="!isEditingTopic">
                <span [@bounceAnimation]="currentRound">{{
                  room?.rounds[currentRound]?.topic
                }}</span>
                <button
                  mat-stroked-button
                  [disabled]="!(permissionsService.canEditTopic() | async)"
                  (click)="onTopicClicked()"
                >
                  <mat-icon>edit</mat-icon>
                  Edit topic
                </button>
              </h2>
              <app-topic-editor
                *ngIf="isEditingTopic"
                [roomTopic]="roomTopic$"
                (topicUpdated)="topicBlur($event)"
                (canceled)="isEditingTopic = false"
              ></app-topic-editor>
              <app-rich-topic
                [richTopic]="(roomTopic$ | async)?.richTopic"
                [roundStatistics]="roundStatistics?.[currentRound]"
                [selectedEstimationCardSetValue]="
                  selectedEstimationCardSetValue
                "
                *ngIf="!isEditingTopic"
              ></app-rich-topic>
            </mat-card-content>
          </div>
        </mat-card>
        <ng-container *ngIf="(isSmallScreen$ | async)?.matches === true">
          <ng-container *ngTemplateOutlet="controlPanel" />
        </ng-container>
        <mat-card
          appearance="outlined"
          class="members-card rounded-card"
          resizeMonitor
          [verticalSpacing]="0"
        >
          <div>
            <mat-card-content>
              <app-round-results
                [room]="room"
                [roundStatistics]="roundStatistics"
                [members]="members$ | async"
                [currentRound]="currentRound"
                [selectedEstimationCardSetValue]="
                  selectedEstimationCardSetValue
                "
                [userProfiles$]="userProfiles$"
                [showMemberControls]="true"
              />
            </mat-card-content>
            <div class="card-footer-actions extra-padding">
              <app-notes-field />
            </div>
          </div>
        </mat-card>
        <ng-container *ngIf="(isSmallScreen$ | async)?.matches === false">
          <ng-container *ngTemplateOutlet="anonymousBanner" />
        </ng-container>
      </div>
      <app-card-deck
        [room]="room"
        [currentRound]="currentRound"
        [isObserver]="isObserver"
        [estimationValues]="estimationValues"
        [currentEstimate]="currentEstimate"
      ></app-card-deck>
      <ng-container *ngIf="(isSmallScreen$ | async)?.matches === false">
        <ng-container *ngTemplateOutlet="controlPanel" />
      </ng-container>
      <ng-container *ngIf="(isSmallScreen$ | async)?.matches === true">
        <ng-container *ngTemplateOutlet="anonymousBanner" />
      </ng-container>
      <app-github-badge *ngIf="config.runningIn === 'web'"></app-github-badge>
    </div>
    <app-reactions-renderer
      [members]="members$"
      [roomId]="room?.roomId"
      *ngIf="room"
    />
    <app-carbon-ad
      *ngIf="room"
      placement="app"
      [isPremiumRoom]="
        room?.subscriptionMetadata?.createdWithPlan === 'premium'
      "
    />
  </mat-sidenav-content>
  <mat-sidenav #sidenav [mode]="'over'" position="end" class="topics-sidenav">
    <app-topics-sidebar
      [room]="room"
      [room$]="room$"
      [rounds]="rounds"
      [selectedEstimationCardSetValue]="selectedEstimationCardSetValue"
      [currentRound]="currentRound"
      [roundStatistics]="roundStatistics"
    ></app-topics-sidebar>
  </mat-sidenav>
</mat-sidenav-container>
<ng-template #anonymousBanner>
  <anonymous-user-banner
    [hideable]="true"
    *ngIf="(sessionCount$ | async) > 1"
    class="anonymous-user-banner"
    @fadeAnimation
  ></anonymous-user-banner>
</ng-template>
<ng-template #controlPanel>
  <div class="estimate-container" [class.minimized]="!isControlPaneExpanded">
    <planning-poker-room-controller-panel
      [room]="room"
      [room$]="room$"
      [activeMember$]="activeMember$"
      [rounds]="rounds"
      [currentRound]="currentRound"
      [isEditingTopic]="isEditingTopic"
      [isMuted]="isMuted"
      [estimationCardSets]="estimationCardSets"
      [selectedEstimationCardSetValue]="selectedEstimationCardSetValue"
      [isExpanded]="isControlPaneExpanded"
      (sidebarTriggered)="sidenav.open()"
      (muteClicked)="toggleMute()"
      (inviteClicked)="copyRoomId()"
      (expandClicked)="toggleControlPane()"
    />
  </div>
</ng-template>
