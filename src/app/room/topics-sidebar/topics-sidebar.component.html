<div class="sidenav-header">
  <h3>Rounds</h3>
  <p>
    Manage the rounds in this estimation and download results for later use.
  </p>
</div>
<div class="sidenav-actions">
  <div
    [matTooltip]="
      config.isRunningInZoom
        ? 'Downloading results is only available on the web version of the app.'
        : ''
    "
  >
    <button
      mat-button
      aria-label="Download results as .csv"
      (click)="downloadAsCsv()"
      [disabled]="rounds.length <= 1 || config.isRunningInZoom"
    >
      Download results
    </button>
  </div>
</div>
<div class="round-history-container">
  <ng-container *ngFor="let round of rounds; let roundNumber = index">
    <mat-card
      appearance="outlined"
      class="flat-card"
      *ngIf="(editedRound | async)?.round.id !== round.id; else editRoundCard"
    >
      <mat-card-content>
        <div class="card-header">
          <span class="card-round-number">#{{ roundNumber + 1 }}</span>

          <button mat-icon-button [matMenuTriggerFor]="menu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button
              mat-menu-item
              aria-label="View the results of the given round"
              (click)="detailsPanel.toggle()"
            >
              Details
            </button>
            <button
              mat-menu-item
              aria-label="Set selected round as active"
              (click)="setActiveRound(roundNumber)"
              [disabled]="roundNumber === currentRound"
            >
              Vote now
            </button>
            <button
              mat-menu-item
              aria-label="Revote selected round"
              (click)="revoteRound(roundNumber)"
            >
              Clear votes
            </button>
            <button
              mat-menu-item
              aria-label="Edit topic name of round"
              (click)="editedRound.next({round, roundIndex: roundNumber})"
            >
              Edit topic
            </button>
          </mat-menu>
        </div>

        <h3 class="round-title" [class.active]="roundNumber === currentRound">
          <div class="blob green" *ngIf="roundNumber === currentRound"></div>
          {{ round.topic }}
        </h3>

        <mat-expansion-panel
          class="flat-accordion"
          #detailsPanel
        >
          <ng-template matExpansionPanelContent>
            <app-round-results
              [room]="room"
              [roundStatistics]="roundStatistics"
              [members]="room.members"
              [currentRound]="roundNumber"
              [selectedEstimationCardSetValue]="selectedEstimationCardSetValue"
            >
            </app-round-results>

            <h3 matSubheader>Notes</h3>
            <div class="note-wrapper">
              <p [innerText]="round.notes?.note || 'No notes taken.'"></p>
            </div>
          </ng-template>
        </mat-expansion-panel>
      </mat-card-content>
    </mat-card>
    <ng-template #editRoundCard>
      <div
        class="add-round-container update-round"
        *ngIf="editedRound | async as roundInfo"
      >
        <add-or-update-topic
          [roundNumber]="roundInfo.roundIndex + 1"
          [topicName]="roundInfo.round.topic"
          (onSaveOrUpdate)="updateRoundConfirmed($event)"
          (onCancel)="editedRound.next(undefined)"
        ></add-or-update-topic>
      </div>
    </ng-template>
  </ng-container>
  <div class="add-round-container">
    <button
      mat-flat-button
      color="primary"
      (click)="addRound()"
      *ngIf="!isAddingRound"
      class="add-round-button"
    >
      Add round
    </button>
    <add-or-update-topic
      *ngIf="isAddingRound"
      [roundNumber]="rounds.length + 1"
      (onSaveOrUpdate)="addRoundConfirmed($event)"
      (onCancel)="cancelAddingRound()"
    >
    </add-or-update-topic>
  </div>
</div>
